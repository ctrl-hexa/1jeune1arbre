<script>
    function generateBasicId() {
      // création d'ids qui sert seulement en frontend
      return Math.random().toString(36).substr(2, 10)
    }
    const initialFarmyardId = generateBasicId()

    const state = {
      farmyards: [{
        id: initialFarmyardId
      }]
    }

    const methods = {
      addFarmyard(event) {
        const farmyardId = generateBasicId()
        this.state.farmyards.push({
          id: farmyardId
        })
        this.render()

        const map = this.initMap(farmyardId)
      },
      removeFarmyard(event) {
        const confirmation = confirm("Êtes-vous sur de vouloir supprimer ce chantier ?")
        if (this.state.farmyards.length == 1 || !confirmation) return

        const farmyardId = event.target.id
        const newFarmyardArray = this.state.farmyards.filter((farmyard) => farmyard.id !== farmyardId)
        this.state.farmyards = newFarmyardArray
        this.render()
      },
      async saveForm(event) {
        event.preventDefault();
        const confirmation = confirm("Confirmez-vous l'enregistrement de vos chantiers pédagogiques et de votre profil ?");
        if (!confirmation) return;

        const formValues = Array.from(event.target.elements)
          .filter((input) => input.name)
          .reduce((acc, input) => {
            acc[input.name] = input.value;
            return acc;
          }, {});
        const updatedFarmyards = {};

        // Organisation pour le body
        for (const key in formValues) {
          if (key.startsWith('farmyard_')) {
            // farmyard_example_value_99 --> type = example_value, id = 99
            const match = key.match(/^farmyard_(.+)_(.+)$/)

            if (match) {
              const type = match[1]; // Extraction de tout avant le dernier "_"
              const id = match[2];

              if (!updatedFarmyards[id]) {
                updatedFarmyards[id] = {
                  id
                }
              }

              switch (type) {
                case 'title':
                  updatedFarmyards[id].title = formValues[key];
                  break;
                case 'description':
                  updatedFarmyards[id].description = formValues[key];
                  break;
                case 'category':
                  updatedFarmyards[id].category = formValues[key];
                  break;
                case 'max_attendees':
                  updatedFarmyards[id].max_attendees = formValues[key];
                  break;
                case 'availability':
                  updatedFarmyards[id].availability = formValues[key];
                  break;
                case 'start_date':
                  updatedFarmyards[id].start_date = formValues[key];
                  break;
                case 'end_date':
                  updatedFarmyards[id].end_date = formValues[key];
                  break;
                case 'bus_parking':
                  updatedFarmyards[id].bus_parking = formValues[key];
                  break;
                case 'walkable':
                  updatedFarmyards[id].walkable = formValues[key];
                  break;
                default:
                  console.warn(`Unhandled farmyard field type: ${type}`);
              }
            }
          }
        }

        const completeFarmyards = [];
        state.farmyards.forEach((yard) => {
          const newInfo = updatedFarmyards[yard.id]
          completeFarmyards.push({
            ...newInfo,
            ...yard
          })
        })

        // post
        const {
          provider_departments: departments_list,
          provider_description: description,
          provider_email: email,
          provider_firstname: firstname,
          provider_lastname: lastname,
          provider_title: title,
          provider_website: website,
          provider_phone: phone,
          provider_position: position,
        } = formValues;

        const body = {
          title,
          website,
          departments_list,
          farmyards: completeFarmyards,
          description,
          /*
          user: {
            firstname,
            email,
            lastname,
          }*/
        }

        const newYardProvider = await store.actions.saveYardProvider(body)
      },
      initMap(farmyardId) {
        const mapId = 'map_' + farmyardId
        const mapContainer = document.getElementById(mapId)

        if (mapContainer) {
          const map = L.map(mapId).setView([46.603354, 1.888334], 6) // Centrage sur la France

          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap',
          }).addTo(map)

          var marker = null
          map.on('click', function(e) {
            const latlng = e.latlng
            const {
              lat,
              lng
            } = latlng
            const farmyard = state.farmyards.find((yard) => yard.id === farmyardId)
            farmyard.location = {
              type: "Point",
              coordinates: [lng, lat],
            }

            if (marker) {
              marker.setLatLng(latlng)
            } else {
              // Creation marker
              marker = L.marker(latlng).addTo(map)
            }
          })

          return map //TODO: pas besoin?
        } else {
          console.error(`Map container with id "${mapId}" not found.`)
        }
      },
    }

    function connected() {
      const map = this.initMap(state.farmyards[0].id)
    }
    </script>

    <template>
      <div class="fr-container">
        <section class="fr-grid-row fr-grid-row--gutters fr-py-8w">
          <h1>Vous souhaitez proposer des chantiers pédagogique ?</h1>
          <p>
            Créez votre profil et renseignez vos chantiers pédagogiques. Une fois validé, vos chantiers seront en consultation pour les
            enseignants.
          </p>
          <div class="fr-col-8">
            <form class="fr-grid-row" @submit="saveForm">
              <div class="fr-col-6 fr-p-2v">
                <label class="fr-label" for="provider_firstname">Votre prénom</label>
                <input class="fr-input" type="text" id="provider_firstname" name="provider_firstname" required />
              </div>
              <div class="fr-col-6 fr-p-2v">
                <label class="fr-label" for="provider_lastname">Votre nom</label>
                <input class="fr-input" type="text" id="provider_lastname" name="provider_lastname" required />
              </div>
              <div class="fr-col-6 fr-p-2v">
                <label class="fr-label" for="provider_email">Votre email</label>
                <input class="fr-input" type="email" id="provider_email" name="provider_email" required />
              </div>
              <div class="fr-col-6 fr-p-2v">
                <label class="fr-label" for="provider_title">Votre organisme</label>
                <input class="fr-input" type="text" id="provider_title" name="provider_title" required />
              </div>
              <div class="fr-col-6 fr-p-2v">
                <label class="fr-label" for="provider_website">Site web</label>
                <input class="fr-input" type="text" id="provider_website" name="provider_website" required />
              </div>
              <div class="fr-col-6 fr-p-2v">
                <label class="fr-label" for="provider_description">Description</label>
                <input class="fr-input" type="text" id="provider_description" name="provider_description" required />
              </div>
              <div class="fr-col-6 fr-p-2v">
                <label class="fr-label" for="provider_departments">Liste des départements</label>
                <input class="fr-input" type="text" id="provider_departments" name="provider_departments" required placeholder="ex: 06, 13" />
              </div>
              <div class="fr-col-6 fr-p-2v">
                <label class="fr-label" for="provider_position">Votre position</label>
                <input class="fr-input" type="text" id="provider_position" name="provider_position" required />
              </div>

              <h2>Vos chantiers pédagogiques</h2>
              <section :for="farmyard in state.farmyards" class="fr-col-12 fr-p-2v">
                <div class="fr-grid-row">
                <div class="fr-col-6 fr-p-2v">
                  <label class="fr-label" for="farmyard_title_${farmyard.id}">Nom du chantier</label>
                  <input
                    class="fr-input"
                    type="text"
                    id="farmyard_title_${farmyard.id}"
                    name="farmyard_title_${farmyard.id}"
                    required
                  />
                </div>
                <div class="fr-col-6 fr-p-2v">
                  <label class="fr-label" for="farmyard_category_${farmyard.id}">Catégorie</label>
                  <select class="fr-input" id="farmyard_category_${farmyard.id}" name="farmyard_category_${farmyard.id}" required>
                    <option value="forestier">Forestier</opt{{farmyard.id}}ion>
                    <option value="communal">Plantation en ville</option>
                  </select>
                </div>
                <div class="fr-col-6 fr-p-2v">
                  <label class="fr-label" for="farmyard_description_${farmyard.id}">Description</label>
                  <textarea class="fr-input" id="farmyard_description_${farmyard.id}" name="farmyard_description_${farmyard.id}"> </textarea>
                </div>
                <div class="fr-col-6 fr-p-2v">
                    <label class="fr-label" for="farmyard_max_attendees_${farmyard.id}">Nombre maximum de participants</label>
                    <input
                      class="fr-input"
                      type="number"
                      id="farmyard_max_attendees_${farmyard.id}"
                      name="farmyard_max_attendees_${farmyard.id}"
                      required
                    />
                  </div>

                  <div class="fr-col-6 fr-p-2v">
                    <label class="fr-label" for="farmyard_availability_${farmyard.id}">Disponibilité</label>
                    <input
                      class="fr-input"
                      type="text"
                      id="farmyard_availability_${farmyard.id}"
                      name="farmyard_availability_${farmyard.id}"
                      required
                    />
                  </div>

                  <div class="fr-col-6 fr-p-2v">
                    <label class="fr-label" for="farmyard_start_date_${farmyard.id}">Date de début</label>
                    <input
                      class="fr-input"
                      type="date"
                      id="farmyard_start_date_${farmyard.id}"
                      name="farmyard_start_date_${farmyard.id}"
                      required
                    />
                  </div>

                  <div class="fr-col-6 fr-p-2v">
                    <label class="fr-label" for="farmyard_end_date_${farmyard.id}">Date de fin</label>
                    <input
                      class="fr-input"
                      type="date"
                      id="farmyard_end_date_${farmyard.id}"
                      name="farmyard_end_date_${farmyard.id}"
                      required
                    />
                  </div>

                  <div class="fr-col-6 fr-p-2v">
                    <label class="fr-label" for="farmyard_bus_parking_${farmyard.id}">Parking pour bus</label>
                    <select
                      class="fr-input"
                      id="farmyard_bus_parking_${farmyard.id}"
                      name="farmyard_bus_parking_${farmyard.id}"
                      required
                    >
                      <option value="true">Oui</option>
                      <option value="false">Non</option>
                    </select>
                  </div>

                  <div class="fr-col-6 fr-p-2v">
                    <label class="fr-label" for="farmyard_walkable_${farmyard.id}">Accessible à pied</label>
                    <select
                      class="fr-input"
                      id="farmyard_walkable_${farmyard.id}"
                      name="farmyard_walkable_${farmyard.id}"
                      required
                    >
                      <option value="true">Oui</option>
                      <option value="false">Non</option>
                    </select>
                  </div>
                </div>
                  <div class="fr-col-6 fr-p-2v">
                    <label class="fr-label" for="map_{{ farmyard.id }}">Localisation</label>
                    <div :id="'map_' + farmyard.id" style="height: 300px; width: 100%"></div>
                  </div>

                <button
                  class="fr-btn fr-btn--tertiary-no-outline fr-btn--error"
                  type="button"
                  @click="removeFarmyard"
                  id="${farmyard.id}"
                  :if="state.farmyards.length !== 1"
                >
                  Supprimer ce chantier
                </button>
              </section>

              <ul class="fr-btns-group">
                <li>
                  <button type="button" class="fr-btn fr-btn--secondary" @click="addFarmyard">Ajouter un chantier</button>
                </li>
                <li>
                  <button type="submit" class="fr-btn fr-btn--primary">Enregistrer</button>
                </li>
              </ul>
            </form>
          </div>
        </section>
      </div>
    </template>
